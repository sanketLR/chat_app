{% extends "base.html" %}
{% load static %}
{% block content %}

    {% block nav %}
    
        {% include "navbar.html" %}
        
    {% endblock nav %}

    <script src="{% static "js/check_token.js" %}"></script>

    <style>

        .chat-messages{
            height:500px;
            overflow-y:auto;
        }
        .chat-messages::-webkit-scrollbar {
            display: none;
        }

    </style>

    <body class="bg-gradient-to-r from-gray-900 via-gray-700 to-gray-900">
        <div id="preloader" class="fixed top-0 left-0 w-screen h-screen flex items-center justify-center bg-gray-900 bg-opacity-90 z-50">
            <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-blue-500"></div>
        </div>
        <div class="p-10 lg:p-10 text-center">
            <h1 class="text-3xl lg:text-6xl text-white font-bold drop-shadow-xl">{{room.cr_name}}</h1>
            <h5 class=" text-white">{{request.user.username}}</h5>
        </div>

        <div class="lg:w-2/4 mx-4 lg:mx-auto p-4 bg-transparent border rounded-xl drop-shadow-xl ">
            <div class="chat-messages space-y-3" id="chat-messages">
                
            </div>
        </div>
        <div class="lg:w-2/4 mt-6 mx-4 lg:mx-auto p-4 bg-white rounded-xl drop-shadow-xl">
            <form action="." method="POST" class="flex">
                {% csrf_token %}
                <input type="text" name="content" class="flex-1 mr-3 text-black" placeholder="Your message..." id="chat-message-input">
                <button class="px-5 py-3 rounded-xl text-white  bg-gray-800 hover:bg-gray-700 text-white" id="chat-message-submit">Send</button>
            </form>
        </div><br>
    </body>

    {% block script %}

    {{request.user.username | json_script:"json-username"}}
    {{room_name | json_script:"json-room_name"}}

<script>

    const username = JSON.parse(document.getElementById("json-username").textContent)

    const roomName = JSON.parse(document.getElementById("json-room_name").textContent)

    const ws = new WebSocket(
        'ws://'
        + window.location.host
        +'/ws/grouptchat/'
        + roomName
        +'/'
    )


    document.addEventListener('DOMContentLoaded', function() {
        var chatForm;
        ws.onopen = function (){
            
            console.log("WebSocket Connection open...")
        
        }

        ws.onmessage = function(e){

            e.preventDefault(); 

            const data = JSON.parse(e.data)
            console.log("Before message_update condition", e.data);
            if (data.event === 'message_updated') {
                console.log("In message_updated condition", data);
                console.log("âœ…âœ…âœ…âœ…");
                console.log("inner message updated event in FE");
                const messageId = data.message_id;
                const updatedContent = data.message;
                console.log("messageId ", messageId );
                console.log("updatedContent ", updatedContent);

                const messageElement = document.querySelector(`.message-content[data-message-id="${messageId}"]`);
                console.log("messageElement",messageElement);
                
                if (messageElement) {
                    messageElement.textContent = updatedContent;
                }
            }
            else if(data.event === "message_save"){
                console.log("ðŸš©ðŸš©ðŸš©ðŸš©ðŸš©");
                let html = ' <div class="p-4 bg-gray-200 rounded-xl  ">';
                    html += '<small><p class="font-bold text-right text-black opacity-50"">' + data.now_time + '</p></small>';
                    html += '<p class="font-bold text-black hover:underline">' + data.username + '</p>';
                    
                    html += '<p class="text-black">'+ data.message + '</p></div>';
                    
                    if(username == data.username){
                        html += `<button class="edit-btn${data.message_id}">Edit</button>`;
                    }

                document.querySelector('#chat-messages').innerHTML += html;
                
                scrollToBottom();
                
            }else if (data.pong) {
                return;
            } else {
                alert('Msg was empty');
            }

        }

        ws.onerror = function(event){
            console.log("WebSocket error occurred ...")
        }

        function sendPing() {
            ws.send(JSON.stringify({
                "ping": "ping",
            }));
        }

        const pingInterval = setInterval(sendPing, 10000);

        ws.onclose = function(event){
            console.log("Connection closed ...")
            clearInterval(pingInterval);
        }
        
        function scrollToBottom(){
            const objDiv = document.querySelector('#chat-messages');
            objDiv.scrollTop = objDiv.scrollHeight;
        }

        scrollToBottom();

        chatForm = document.querySelector('form.flex');

        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();

            var getInputText = document.getElementById("chat-message-input").value;
            
            if (document.getElementById('chat-message-submit').textContent === "Update") {
                console.log("In if condition");
                return;
            } else {
                console.log("In else condition come");
                ws.send(JSON.stringify({
                    "msg": getInputText,
                    "user": username,
                    "room" : roomName,
                }));
            }

            document.getElementById("chat-message-input").value = "";
        });
    });

    document.getElementById('preloader').style.display = 'flex';
        
    document.addEventListener('DOMContentLoaded', async function () {
        
        await loadChatData();

    });


    async function loadChatData() {
        try {

            const roomName = JSON.parse(document.getElementById("json-room_name").textContent)

            const accessToken = localStorage.getItem("accessToken");
            
            const response = await fetch('http://127.0.0.1:8000/api/messenger/LoadChatData/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                },
                body : JSON.stringify(roomName)
            });
            
            const data = await response.json();

            if (data.status === 200) {

                data.result.forEach(message => {
                    let html = '<div class="p-4 bg-gray-200 rounded-xl">';
                    html += '<small><p class="font-bold text-right opacity-50 text-black">' + message.date_added + '</p></small>';
                    html += '<p class="font-bold text-black hover:underline">' + message.user + '</p>';
                    html += '<p class="text-black message-content" data-message-id="' + message.id + '">' + message.content + '</p></div>';
                    if(username == message.user){

                        html += `<button class="edit-btn${message.id}">Edit</button>`;
                    }

                    document.querySelector('#chat-messages').innerHTML += html;

                });

                scrollToBottom();

                data.result.forEach(message => {
                    document.querySelectorAll(`.edit-btn${message.id}`).forEach(function (editButton) {
                        editButton.addEventListener('click', function () {
                            console.log("Edit button clicked.");

                            var messageId = this.classList[0].replace('edit-btn', '');
                            console.log("messageId", messageId);

                            var messageContent = document.querySelector('.message-content[data-message-id="' + messageId + '"]').textContent;
                            console.log("messageContent", messageContent);

                            document.getElementById('chat-message-input').value = messageContent.trim();
                
                            document.getElementById('chat-message-submit').textContent = "Update";
                            
                            var update_chatForm = document.querySelector('form.flex');

                            
                            document.getElementById('chat-message-submit').addEventListener('click', function () {
                                console.log("Work on updating");
                                
                                var messageContent = document.getElementById("chat-message-input").value;
                                console.log("New Message after click on edit", messageContent)
                                console.log("Message id after click on edit", messageId);
                                
                                this.textContent = "Send";

                                var data = {
                                    action: 'update_message',
                                    message_id: messageId,
                                    updated_content: messageContent
                                };

                                console.log("Before send message to server");
                                ws.send(JSON.stringify(data));
                                console.log("After send message to server");

                            });
                        });
                    });
                });

            } else {

                console.error('Failed to fetch chat data.');
                window.location = "http://127.0.0.1:8000/api/messenger/signIn/";

            }
        } catch (error) {
            console.error('Error fetching chat data:', error);
        } finally {
            document.getElementById('preloader').style.display = 'none';
        }
    }


    function scrollToBottom() {
        const objDiv = document.querySelector('#chat-messages');
        objDiv.scrollTop = objDiv.scrollHeight;
    }
        
</script>
<script>
    document.addEventListener('DOMContentLoaded', function(e){

        e.preventDefault()

        let getSignUpLink = document.getElementById("SignUpLink")
        let getSignInLink = document.getElementById("SignInLink")
        
        getSignUpLink.remove()
        getSignInLink.remove()

    })
</script>
    {% endblock script %}
{% endblock content %}
